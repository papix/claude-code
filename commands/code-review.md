# Comprehensive code review for current branch

## 概要
現在のブランチの実装を包括的にレビューし、コード品質の評価と改善点を指摘します。
mainブランチで実行した場合は、プロジェクト全体のコードをレビュー対象とします。

## 使用方法
```
/code-review
```

## レビュー内容

### 1. 実装の概要
- 変更されたファイルの統計
- 主要な機能追加・変更点
- アーキテクチャの変更

### 2. 評価項目

#### コード品質
- TypeScriptの型安全性
- 命名規則の一貫性
- コードの重複
- 不要なコードの有無（未使用の変数、関数、インポート等）
- コメントの品質（不要な・過剰なコメントの検出）

#### アーキテクチャ
- レイヤー分離の適切性
- 責任の分離
- 既存パターンとの整合性
- 依存関係の方向

#### パフォーマンス
- N+1問題の回避
- 不要な再レンダリング
- 大量データへの対応
- 最適化の余地

#### セキュリティ
- 認証・認可の実装
- 入力値の検証
- SQLインジェクション対策
- XSS対策

#### 保守性
- コードの可読性
- 将来の拡張性
- テストの書きやすさ
- ドキュメントの充実度

### 3. 問題の重要度

- **🔴 Critical**: 必ず修正すべき重大な問題
- **🟠 Major**: 修正を強く推奨する問題
- **🟡 Minor**: 改善の余地がある箇所
- **🔵 Suggestion**: より良い実装の提案

## 実行手順

1. 現在のブランチを確認
2. mainブランチとの差分を取得（mainブランチの場合は全コードをレビュー対象とする）
3. 未使用のコードや不要な実装を検出
4. 不要な実装があれば削除してコミット
5. 不要な・過剰なコメントを検出
6. 問題のあるコメントがあれば修正してコミット
7. 変更されたファイル（mainの場合は全ファイル）を分析
8. 各評価項目に基づいてレビュー
9. 総合評価と改善提案を出力

## 出力例

### ブランチレビューの場合
```
## 🧹 不要なコードの自動削除

検出された未使用のコード:
- src/lib/utils/unused-helper.ts: 未使用の関数 `oldHelper`
- src/components/features/tags/tag-utils.ts: 未使用のインポート `useState`

上記を削除してコミットしました。

## 💬 不要なコメントの自動修正

検出された問題のあるコメント:
- src/actions/conversation.ts:45: 自明なコメント「// idを取得」を削除
- src/lib/services/user.service.ts:120-125: コメントアウトされた古いコードを削除
- src/components/ConversationList.tsx:88: 解決済みのTODOコメントを削除

上記を修正してコミットしました。

## 📋 実装レビュー結果

### 概要
- ブランチ: feature/conversation-tags-implementation
- 変更ファイル: 17ファイル (+970行, -4行)
- 主な実装: 会話へのタグ機能追加

### ✅ 良い点
- 適切なレイヤー分離
- TypeScriptの型定義が充実
- N+1問題を考慮した実装

### 📌 改善点

#### 🔴 Critical (1件)
1. **セキュリティ: 権限チェックの不備**
   - ファイル: `src/actions/tags.ts`
   - 問題: deleteタグで権限チェックが不足

#### 🟠 Major (2件)
1. **エラーハンドリング: エラーの握りつぶし**
   - ファイル: `src/actions/tags.ts:90`
   - 問題: cleanupエラーを無視している

### 💡 改善提案
1. エラーハンドリングの統一
2. より詳細なログ出力
3. パフォーマンステストの追加
```

### mainブランチでの全体レビューの場合
```
## 📋 プロジェクト全体のコードレビュー結果

### 概要
- ブランチ: main
- 総ファイル数: 156ファイル
- コード行数: 12,450行
- レビュー対象: プロジェクト全体

### ✅ 全体的な良い点
- アーキテクチャの一貫性が保たれている
- TypeScriptの型定義が充実
- レイヤー分離が適切

### 📌 プロジェクト全体の改善点

#### 🔴 Critical (3件)
1. **セキュリティ: 認証チェックの不一致**
   - 一部のServer Actionsで認証チェックが不足
   - 影響範囲: src/actions/配下の5ファイル

2. **パフォーマンス: N+1問題**
   - 会話一覧取得時の関連データ取得
   - ファイル: `src/lib/services/conversation.service.ts`

#### 🟠 Major (5件)
1. **コードの重複**
   - 同様のエラーハンドリングロジックが複数箇所に存在
   - 共通化の余地あり

### 🏗️ アーキテクチャの改善提案
1. エラーハンドリングの統一化
2. 共通ユーティリティの整理
3. テストカバレッジの向上（現在: 45%）

### 📊 コード品質メトリクス
- 型カバレッジ: 92%
- 未使用コード: 12ファイル
- 循環的複雑度が高い関数: 8箇所
```

## 注意事項

### レビューの観点
- **自動クリーンアップ**: 未使用のコードは自動的に削除してコミット
- **包括性**: セキュリティ、パフォーマンス、保守性を総合的に評価
- **実用性**: 具体的な改善提案と実装方法を提示
- **優先順位**: Critical → Major → Minor → Suggestion の順で対応を推奨

### 未使用コードの検出
- TypeScriptコンパイラの`--noUnusedLocals`と`--noUnusedParameters`相当のチェック
- 未使用のインポート、変数、関数、型定義を検出
- 検出されたものは自動的に削除してコミット

### コード重複の確認
- TypeScriptプロジェクトでコード重複を確認したい場合は、別途 `/code-duplicate` コマンドを使用してください
- 重複検出により、リファクタリングの機会を特定できます

## よくある使用シーン

### プルリクエスト作成前
```bash
# 全体的なコードレビュー
/code-review

# 特定の観点でレビュー
/code-review --focus security
/code-review --focus performance
```

### 大規模な変更後
```bash
# パフォーマンスに焦点を当てたレビュー
/code-review --focus performance

# アーキテクチャの観点でレビュー
/code-review --focus architecture
```

### デバッグ時
```bash
# エラーハンドリングの確認
/code-review --focus error-handling

# 型安全性の確認
/code-review --focus type-safety
```

## 関連コマンド

- `/code-review-suggest` - 具体的な改善案付きのレビュー
- `/code-duplicate` - 重複コードの検出
- `/task` - レビュー結果を基にした改善タスクの計画
- `/claude-learnings` - レビューで得た知見の記録

### 不要な・過剰なコメントの検出基準
以下のようなコメントを検出し、自動的に削除または修正します：

#### 削除対象のコメント
- **自明なコメント**: コードを読めば分かる内容の説明
  ```typescript
  // idを取得
  const id = user.id
  
  // ユーザー名を設定
  setUserName(name)
  ```
- **コメントアウトされたコード**: 使われていない古いコード
- **解決済みのTODO/FIXME**: 既に対応が完了しているもの
- **古い実装の説明**: 現在のコードと一致しない説明

#### 修正対象のコメント
- **過剰に詳細なコメント**: 複雑でない処理に対する長い説明
- **冗長なコメント**: 同じ内容を繰り返している説明

#### 保持すべきコメント
- **複雑なビジネスロジックの説明**
- **なぜその実装にしたかの理由**
- **将来の改善点や注意事項**
- **外部仕様への参照**
- **パフォーマンスやセキュリティに関する重要な注記**
